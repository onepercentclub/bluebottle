name: tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: Testing
    container: python:3.9-bullseye    # <-- pin a Debian base you expect
    services:
      postgres:
        image: postgis/postgis:14-3.3
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        options: >-
          --health-cmd="curl -s http://localhost:9200 >/dev/null || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      DJANGO_SETTINGS_MODULE: bluebottle.settings.testing

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            libxmlsec1 libxmlsec1-dev \
            libgdal-dev swig \
            postgresql-client \
            curl

      - name: Wait for services
        run: |
          for i in {1..60}; do
            (pg_isready -h postgres -p 5432 -U postgres && curl -s http://elasticsearch:9200 >/dev/null) && break
            sleep 2
          done

      - name: Bootstrap database
        run: |
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d postgres -c "CREATE USER testuser WITH PASSWORD 'password';"
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d postgres -c "ALTER ROLE testuser CREATEDB;"
          PGPASSWORD=password createdb -h postgres -p 5432 -U testuser test_bluebottle_test
          PGPASSWORD=password psql -h postgres -p 5432 -U testuser -d test_bluebottle_test -f testdata.sql

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip==20.2.1
          pip install setuptools==58.2.0
          pip install wheel
          pip install -e ".[test]" --trusted-host github.com
        env:
          PIP_CACHE_DIR: /tmp/pip-cache

      - name: Run tests (coverage)
        run: |
          python -m coverage run --parallel-mode --source=bluebottle manage.py test --keepdb --parallel 8 --settings bluebottle.settings.runner

      - name: After success (post_travis + coverage report)
        run: |
          bash post_travis.sh
          python -m coverage combine
          python -m coverage report --omit "**/migrations/**"
