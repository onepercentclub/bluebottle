on:
  pull_request:

jobs:
  test:
    name: Automated tests
    runs-on: Testing

    services:
      postgres:
        image: postgis/postgis:14-3.3
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432/tcp
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200/tcp
        options: >-
          --health-cmd="curl -s http://localhost:9200 >/dev/null || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      DJANGO_SETTINGS_MODULE: bluebottle.settings.runner
      LANG: en_GB.UTF-8
      LC_ALL: en_GB.UTF-8
      VENV_DIR: /home/github_actions_runner/venvs/bluebottle-py39
      PIP_CACHE_DIR: /home/github_actions_runner/.cache/pip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export service ports
        run: |
          echo "PGHOST=127.0.0.1" >> "$GITHUB_ENV"
          echo "PGPORT=${{ job.services.postgres.ports[5432] }}" >> "$GITHUB_ENV"
          echo "ESHOST=127.0.0.1" >> "$GITHUB_ENV"
          echo "ESPORT=${{ job.services.elasticsearch.ports[9200] }}" >> "$GITHUB_ENV"

      - name: Install system dependencies (host)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            locales \
            libxmlsec1 libxmlsec1-dev \
            libgdal-dev swig \
            postgresql-client \
            curl
          sudo sed -i 's/^# *\(en_GB.UTF-8 UTF-8\)/\1/' /etc/locale.gen
          sudo locale-gen
          sudo update-locale LANG=en_GB.UTF-8

      - name: Wait for services
        run: |
          echo "Waiting for Postgres on $PGHOST:$PGPORT and Elasticsearch on $ESHOST:$ESPORT"
          for i in {1..60}; do
            (pg_isready -h "$PGHOST" -p "$PGPORT" -U postgres && curl -s "http://$ESHOST:$ESPORT" >/dev/null) && exit 0
            sleep 2
          done
          echo "Services did not become ready"
          exit 1

      - name: Bootstrap database
        run: |
          set -e

          # Create user if it does not exist
          PGPASSWORD=postgres psql -h "$PGHOST" -p "$PGPORT" -U postgres -d postgres <<'SQL'
          DO $$
          BEGIN
            IF NOT EXISTS (
              SELECT FROM pg_catalog.pg_roles WHERE rolname = 'testuser'
            ) THEN
              CREATE ROLE testuser LOGIN PASSWORD 'password';
            END IF;
          END
          $$;
          ALTER ROLE testuser WITH SUPERUSER CREATEDB CREATEROLE;
          SQL

          # Drop test database if it exists
          PGPASSWORD=postgres psql -h "$PGHOST" -p "$PGPORT" -U postgres -d postgres <<'SQL'
          SELECT pg_terminate_backend(pid)
          FROM pg_stat_activity
          WHERE datname = 'test_bluebottle_test'
            AND pid <> pg_backend_pid();
          DROP DATABASE IF EXISTS test_bluebottle_test;
          SQL

          # Recreate database
          PGPASSWORD=password createdb -h "$PGHOST" -p "$PGPORT" -U testuser test_bluebottle_test

          # Ensure extensions exist in template1 so new DBs inherit them
          PGPASSWORD=postgres psql -h "$PGHOST" -p "$PGPORT" -U postgres -d template1 <<'SQL'
          CREATE EXTENSION IF NOT EXISTS postgis;
          CREATE EXTENSION IF NOT EXISTS postgis_topology;
          CREATE EXTENSION IF NOT EXISTS unaccent;
          SQL

          # Load test data
          PGPASSWORD=password psql -h "$PGHOST" -p "$PGPORT" -U testuser -d test_bluebottle_test -f testdata.sql

      - name: Create/upgrade persistent venv
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$(dirname "$VENV_DIR")" "$PIP_CACHE_DIR"
          if [ ! -x "$VENV_DIR/bin/python" ]; then
            python -m venv "$VENV_DIR"
          fi
          source "$VENV_DIR/bin/activate"
          python -m pip install --upgrade pip wheel
          python -m pip install --upgrade "setuptools==58.2.0"
          python -m pip --version          
          python -m pip install --no-build-isolation -e ".[test]" --trusted-host github.com
      

      - name: Install Python dependencies only when setup.py changes
        shell: bash
        run: |
          set -euxo pipefail
          source "$VENV_DIR/bin/activate"

          NEW_SHA="$(python - <<'PY'
          import hashlib
          from pathlib import Path
          p = Path("setup.py")
          print(hashlib.sha256(p.read_bytes()).hexdigest())
          PY
          )"
          STAMP="$VENV_DIR/.deps-setup_py.sha"
          OLD_SHA="$(cat "$STAMP" 2>/dev/null || true)"

          if [ "$NEW_SHA" != "$OLD_SHA" ]; then
            echo "Dependency definition changed; installing..."
            python -m pip install -e ".[test]" --trusted-host github.com
            echo "$NEW_SHA" > "$STAMP"
          else
            echo "setup.py unchanged; skipping dependency install."
          fi

      - name: Run tests (coverage)
        shell: bash
        run: |
          set -euxo pipefail
          source "$VENV_DIR/bin/activate"
          python manage.py test --parallel 8 --settings bluebottle.settings.runner
