name: tests

on:
  pull_request:

jobs:
  test:
    runs-on: Testing
    container: python:3.9-bullseye    # <-- pin a Debian base you expect
    services:
      postgres:
        image: postgis/postgis:14-3.3
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        options: >-
          --health-cmd="curl -s http://localhost:9200 >/dev/null || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=20

    env:
      DJANGO_SETTINGS_MODULE: bluebottle.settings.runner
      LANG: en_GB.UTF-8
      LC_ALL: en_GB.UTF-8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            locales \
            libxmlsec1 libxmlsec1-dev \
            libgdal-dev swig \
            postgresql-client \
            curl
          sed -i 's/^# *\(en_GB.UTF-8 UTF-8\)/\1/' /etc/locale.gen
          locale-gen
          update-locale LANG=en_GB.UTF-8

      - name: Wait for services
        run: |
          for i in {1..60}; do
            (pg_isready -h postgres -p 5432 -U postgres && curl -s http://elasticsearch:9200 >/dev/null) && break
            sleep 2
          done

      - name: Bootstrap database
        run: |
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d postgres -c "CREATE USER testuser WITH PASSWORD 'password';"
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d postgres -c "ALTER ROLE testuser  WITH SUPERUSER CREATEDB CREATEROLE;"
          PGPASSWORD=password createdb -h postgres -p 5432 -U testuser test_bluebottle_test
          PGPASSWORD=password psql -h postgres -p 5432 -U testuser -d test_bluebottle_test -f testdata.sql
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d template1 -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d template1 -c "CREATE EXTENSION IF NOT EXISTS postgis_topology;"
          PGPASSWORD=postgres psql -h postgres -p 5432 -U postgres -d template1 -c "CREATE EXTENSION IF NOT EXISTS unaccent;"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: /tmp/pip-cache
          key: ${{ runner.os }}-py39-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.cfg', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-py39-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.cfg', '**/setup.py') }}

      - name: Install Python dependencies
        env:
          PIP_CACHE_DIR: /tmp/pip-cache
        run: |
          python -m pip install --upgrade "pip==24.0" "setuptools==58.2.0" wheel
          python -m pip --version
          python -m pip install -e ".[test]" --trusted-host github.com

      - name: Run tests (coverage)
        run: |
          python -m coverage run --parallel-mode --source=bluebottle manage.py test --keepdb --parallel 8 --settings bluebottle.settings.runner

      - name: After success (post_travis + coverage report)
        run: |
          bash post_travis.sh
          python -m coverage combine
          python -m coverage report --omit "**/migrations/**"
