dist: jammy
sudo: required
language: python
addons:
  postgresql: "14"
  apt:
    packages:
      - libxmlsec1
      - libxmlsec1-dev
      - libgdal-dev
      - swig
      - openjdk-8-jdk-headless
      - postgresql
      - postgresql-client
      - postgresql-postgis
      - postgis
cache:
  pip: true
python:
  - 3.9
services:
  - postgresql
  - elasticsearch
env:
  global:
    - DJANGO_SETTINGS_MODULE='bluebottle.settings.testing'
before_install:
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/14/main/pg_hba.conf
  - sudo service postgresql@13-main restart
  - sleep 1
  - psql -U postgres -c "CREATE USER testuser WITH PASSWORD 'password';"
  - psql -U postgres -c "ALTER ROLE testuser SUPERUSER;"
  - createdb test_bluebottle_test -U testuser
  - psql -U testuser test_bluebottle_test < testdata.sql
install:
  - pip install pip==20.2.1
  - pip install setuptools==58.2.0
  - pip install wheel
  - pip install -e .[test] --trusted-host github.com
script:
  - python -m coverage run --parallel-mode --source=bluebottle manage.py test --keepdb
notifications:
  slack:
    secure: TOveMBh9HePYKWuGTrWF+hTXzxGZvbVsa3KU0sB1yv6qkcixb5/ggvmkTeRddYEd/zyWyMenicFsrXVBgsP0SmbNgke6kq5+EN0U5oJWse998lvCVCpwmJQMdwDHvYsOtbFEOppQrbRK4vmH8qibx3x2YVg+u+61ePHvWYF9z6U=
after_success:
  - bash post_travis.sh
  - python -m coverage combine; python -m coverage report --omit "**/migrations/**"; coveralls
