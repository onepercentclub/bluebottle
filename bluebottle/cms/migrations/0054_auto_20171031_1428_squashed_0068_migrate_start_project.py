# -*- coding: utf-8 -*-
# Generated by Django 1.11.15 on 2019-09-12 13:32
from __future__ import unicode_literals

import adminsortable.fields
from django.db import migrations, models
import django.db.migrations.operations.special
import django.db.models.deletion
import django.db.models.manager
from bluebottle.utils.utils import update_group_permissions


def migrate_site_platform_settings(apps, schema_editor):
    SitePlatformSettings = apps.get_model('cms', 'SitePlatformSettings')
    site_setttings, _ = SitePlatformSettings.objects.get_or_create()
    site_setttings.save()


def add_group_permissions(apps, schema_editor):
    group_perms = {
        'Anonymous': {
            'perms': (
                'api_read_page',
            )
        },
        'Authenticated': {
            'perms': (
                'api_read_page',
            )
        },
    }

    update_group_permissions('pages', group_perms, apps)

    group_perms = {
        'Anonymous': {
            'perms': (
                'api_read_newsitem',
            )
        },
        'Authenticated': {
            'perms': (
                'api_read_newsitem',
            )
        },
    }

    update_group_permissions('news', group_perms, apps)


def migrate_start_project(apps, schema_editor):
    Link = apps.get_model('cms', 'Link')
    Language = apps.get_model('utils', 'language')
    english = Language.objects.filter(language_name='English').first()
    dutch = Language.objects.filter(language_name='Dutch').first()
    french = Language.objects.filter(language_name='French').first()

    if english:
        Link.objects.filter(
            component='page',
            component_id='start-project',
            link_group__site_links__language=english.id
        ).update(
            component='initiatives.start',
            component_id='',
            title='Start an initiative'
        )
        Link.objects.filter(
            component='project',
            link_group__site_links__language=english.id
        ).update(
            component='initiatives.activities.list',
            component_id='',
            title='Search activities'
        )

    if dutch:
        Link.objects.filter(
            component='page',
            component_id='start-project',
            link_group__site_links__language=dutch.id
        ).update(
            component='initiatives.start',
            component_id='',
            title='Start een initiatief'
        )
        Link.objects.filter(
            component='project',
            link_group__site_links__language=dutch.id
        ).update(
            component='initiatives.activities.list',
            component_id='',
            title='Zoek activiteiten'
        )

    if french:
        Link.objects.filter(
            component='page',
            component_id='start-project',
            link_group__site_links__language=french.id
        ).update(
            component='initiatives.start',
            component_id='',
            title='Lancez votre participatif'
        )
        Link.objects.filter(
            component='project',
            link_group__site_links__language=french.id
        ).update(
            component='initiatives.activities.list',
            component_id='',
            title='Rechercher des activit√©s'
        )


class Migration(migrations.Migration):

    replaces = [('cms', '0054_auto_20171031_1428'), ('cms', '0021_auto_20171017_2015'), ('cms', '0022_auto_20171019_1725'), ('cms', '0023_auto_20171019_2042'), ('cms', '0024_siteplatformsettings'), ('cms', '0025_auto_20171024_1600'), ('cms', '0055_merge_20171031_1713'), ('cms', '0056_auto_20171102_1527'), ('cms', '0057_auto_20171103_1438'), ('cms', '0058_auto_20171110_1230'), ('cms', '0059_auto_20171121_1022'), ('cms', '0059_auto_20171121_0959'), ('cms', '0060_merge_20171121_1334'), ('cms', '0061_auto_20171128_1135'), ('cms', '0062_auto_20171128_1355'), ('cms', '0063_auto_20171204_1049'), ('cms', '0064_auto_20171220_1145'), ('cms', '0065_auto_20180313_1401'), ('cms', '0066_auto_20180709_1657'), ('cms', '0067_auto_20190710_0938'), ('cms', '0068_migrate_start_project')]

    dependencies = [
        ('news', '0007_auto_20180709_1706'),
        ('cms', '0053_auto_20171030_1645'),
        ('utils', '0002_maillog'),
        ('fluent_contents', '0001_initial'),
        ('pages', '0009_auto_20180709_1706'),
        ('funding', '0027_merge_20190912_1324'),
    ]

    operations = [
        migrations.AlterField(
            model_name='projectscontent',
            name='projects',
            field=models.ManyToManyField(blank=True, db_table='cms_projectscontent_projects', to='projects.Project'),
        ),
        migrations.AlterField(
            model_name='quote',
            name='quote',
            field=models.TextField(),
        ),
        migrations.CreateModel(
            name='Link',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('highlight', models.BooleanField(default=False)),
                ('title', models.CharField(max_length=100, verbose_name='Title')),
                ('component', models.CharField(blank=True, choices=[('page', 'Page'), ('project', 'Project'), ('task', 'Task'), ('fundraiser', 'Fundraiser'), ('results', 'Results'), ('news', 'News')], max_length=50, verbose_name='Component')),
                ('component_id', models.CharField(blank=True, max_length=100, verbose_name='Component ID')),
                ('external_link', models.CharField(blank=True, max_length=2000, verbose_name='External Link')),
                ('link_order', models.PositiveIntegerField(db_index=True, default=0, editable=False)),
            ],
            options={
                'ordering': ['link_order'],
            },
        ),
        migrations.CreateModel(
            name='LinkGroup',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(choices=[('main', 'Main'), ('about', 'About'), ('info', 'Info'), ('discover', 'Discover'), ('social', 'Social')], default='main', max_length=25, unique=True)),
                ('title', models.CharField(blank=True, max_length=50, verbose_name='Title')),
            ],
        ),
        migrations.CreateModel(
            name='LinkPermission',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('permission', models.CharField(help_text='A dot separated app name and permission codename.', max_length=255)),
                ('present', models.BooleanField(default=True, help_text='Should the permission be present or not to access the link?')),
            ],
        ),
        migrations.CreateModel(
            name='SiteLinks',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('has_copyright', models.BooleanField(default=True)),
                ('language', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, to='utils.Language')),
            ],
            options={
                'verbose_name_plural': 'Site links',
            },
        ),
        migrations.AddField(
            model_name='linkgroup',
            name='site_links',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='link_groups', to='cms.SiteLinks'),
        ),
        migrations.AddField(
            model_name='link',
            name='link_group',
            field=adminsortable.fields.SortableForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='links', to='cms.LinkGroup'),
        ),
        migrations.AddField(
            model_name='link',
            name='link_permissions',
            field=models.ManyToManyField(blank=True, to='cms.LinkPermission'),
        ),
        migrations.AlterField(
            model_name='link',
            name='component',
            field=models.CharField(blank=True, choices=[('page', 'Page'), ('project', 'Project'), ('task', 'Task'), ('fundraiser', 'Fundraiser'), ('results', 'Results'), ('news', 'News')], max_length=50, null=True, verbose_name='Component'),
        ),
        migrations.AlterField(
            model_name='link',
            name='component_id',
            field=models.CharField(blank=True, max_length=100, null=True, verbose_name='Component ID'),
        ),
        migrations.AlterField(
            model_name='link',
            name='external_link',
            field=models.CharField(blank=True, max_length=2000, null=True, verbose_name='External Link'),
        ),
        migrations.AlterField(
            model_name='linkgroup',
            name='name',
            field=models.CharField(choices=[('main', 'Main'), ('about', 'About'), ('info', 'Info'), ('discover', 'Discover'), ('social', 'Social')], default='main', max_length=25),
        ),
        migrations.AlterModelOptions(
            name='linkgroup',
            options={'ordering': ['group_order']},
        ),
        migrations.AddField(
            model_name='linkgroup',
            name='group_order',
            field=models.PositiveIntegerField(db_index=True, default=0, editable=False),
        ),
        migrations.CreateModel(
            name='SitePlatformSettings',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('update', models.DateTimeField(auto_now=True)),
                ('contact_email', models.EmailField(blank=True, max_length=254, null=True)),
                ('contact_phone', models.CharField(blank=True, max_length=100, null=True)),
                ('copyright', models.CharField(blank=True, max_length=100, null=True)),
                ('powered_by_text', models.CharField(blank=True, max_length=100, null=True)),
                ('powered_by_link', models.CharField(blank=True, max_length=100, null=True)),
                ('powered_by_logo', models.ImageField(blank=True, null=True, upload_to='site_content/')),
            ],
            options={
                'verbose_name': 'site platform settings',
                'verbose_name_plural': 'site platform settings',
            },
        ),
        migrations.RunPython(
            migrate_site_platform_settings,
            migrations.RunPython.noop,
        ),
        migrations.CreateModel(
            name='Greeting',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('text', models.TextField()),
            ],
        ),
        migrations.CreateModel(
            name='WelcomeContent',
            fields=[
                ('contentitem_ptr', models.OneToOneField(auto_created=True, on_delete=django.db.models.deletion.CASCADE, parent_link=True, primary_key=True, serialize=False, to='fluent_contents.ContentItem')),
                ('preamble', models.CharField(max_length=20)),
            ],
            options={
                'abstract': False,
                'db_table': 'contentitem_cms_welcomecontent',
                'verbose_name': 'Welcome',
            },
            bases=('fluent_contents.contentitem',),
            managers=[
                ('objects', django.db.models.manager.Manager()),
                ('base_objects', django.db.models.manager.Manager()),
            ],
        ),
        migrations.AddField(
            model_name='greeting',
            name='block',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='greetings', to='cms.WelcomeContent'),
        ),
        migrations.AddField(
            model_name='logo',
            name='link',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AlterField(
            model_name='link',
            name='component',
            field=models.CharField(blank=True, choices=[('page', 'Page'), ('project', 'Project'), ('task', 'Task'), ('fundraiser', 'Fundraiser'), ('results-page', 'Results Page'), ('news', 'News')], max_length=50, null=True, verbose_name='Component'),
        ),
        migrations.AddField(
            model_name='contentlink',
            name='sequence',
            field=models.PositiveIntegerField(db_index=True, default=0, editable=False),
        ),
        migrations.AddField(
            model_name='logo',
            name='sequence',
            field=models.PositiveIntegerField(db_index=True, default=0, editable=False),
        ),
        migrations.AddField(
            model_name='slide',
            name='sequence',
            field=models.PositiveIntegerField(db_index=True, default=0, editable=False),
        ),
        migrations.AddField(
            model_name='step',
            name='sequence',
            field=models.PositiveIntegerField(db_index=True, default=0, editable=False),
        ),
        migrations.AlterField(
            model_name='link',
            name='component',
            field=models.CharField(blank=True, choices=[('page', 'Page'), ('project', 'Project'), ('task', 'Task'), ('fundraiser', 'Fundraiser'), ('results-page', 'Results Page'), ('news', 'News')], max_length=50, null=True, verbose_name='Component'),
        ),
        migrations.AlterModelOptions(
            name='contentlink',
            options={'ordering': ['sequence']},
        ),
        migrations.AlterModelOptions(
            name='logo',
            options={'ordering': ['sequence']},
        ),
        migrations.AlterModelOptions(
            name='slide',
            options={'ordering': ['sequence']},
        ),
        migrations.AlterModelOptions(
            name='step',
            options={'ordering': ['sequence']},
        ),
        migrations.AlterField(
            model_name='categoriescontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='linkscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='locationscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='logoscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='projectimagescontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='projectscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='projectsmapcontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='quotescontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='shareresultscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='slidescontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='statscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='stepscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='supportertotalcontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='surveycontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='taskscontent',
            name='title',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AlterField(
            model_name='step',
            name='text',
            field=models.CharField(blank=True, max_length=400, null=True, verbose_name='Text'),
        ),
        migrations.AlterField(
            model_name='logoscontent',
            name='action_text',
            field=models.CharField(blank=True, max_length=40, null=True),
        ),
        migrations.AddField(
            model_name='siteplatformsettings',
            name='favicon',
            field=models.ImageField(blank=True, null=True, upload_to='site_content/'),
        ),
        migrations.AddField(
            model_name='siteplatformsettings',
            name='logo',
            field=models.ImageField(blank=True, null=True, upload_to='site_content/'),
        ),
        migrations.AlterField(
            model_name='stat',
            name='type',
            field=models.CharField(choices=[('manual', 'Manual input'), ('people_involved', 'People involved'), ('participants', 'Participants'), ('projects_realized', 'Projects realised'), ('projects_complete', 'Projects complete'), ('tasks_realized', 'Tasks realised'), ('task_members', 'Taskmembers'), ('donated_total', 'Donated total'), ('pledged_total', 'Pledged total'), ('amount_matched', 'Amount matched'), ('projects_online', 'Projects Online'), ('votes_cast', 'Votes casts'), ('time_spent', 'Time spent'), ('members', 'Number of members')], max_length=25),
        ),
        migrations.RunPython(
            add_group_permissions,
        ),
        migrations.CreateModel(
            name='ActivitiesContent',
            fields=[
                ('contentitem_ptr', models.OneToOneField(auto_created=True, on_delete=django.db.models.deletion.CASCADE, parent_link=True, primary_key=True, serialize=False, to='fluent_contents.ContentItem')),
                ('title', models.CharField(blank=True, max_length=50, null=True)),
                ('sub_title', models.CharField(blank=True, max_length=400, null=True)),
                ('action_text', models.CharField(blank=True, default='Find more activities', max_length=80, null=True)),
                ('action_link', models.CharField(blank=True, default='/initiatives/activities/list', max_length=100, null=True)),
                ('highlighted', models.BooleanField(default=False)),
                ('activities', models.ManyToManyField(blank=True, db_table='cms_activitycontent_activities', to='activities.Activity')),
            ],
            options={
                'db_table': 'contentitem_cms_activitiescontent',
                'verbose_name': 'Activities',
            },
            bases=('fluent_contents.contentitem',),
            managers=[
                ('objects', django.db.models.manager.Manager()),
                ('base_objects', django.db.models.manager.Manager()),
            ],
        ),
        migrations.RunPython(
            migrate_start_project,
            migrations.RunPython.noop,
        ),
    ]
