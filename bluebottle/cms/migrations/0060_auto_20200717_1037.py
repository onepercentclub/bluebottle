# -*- coding: utf-8 -*-
# Generated by Django 1.11.15 on 2020-07-17 08:37
from __future__ import unicode_literals

from django.core.exceptions import ObjectDoesNotExist
from django.db import migrations, models
from django.utils.translation import activate, _trans
from tenant_extras.middleware import tenant_translation
from parler.models import TranslatableModelMixin


def migrate_hompepage_statistics(apps, schema_editor):
    StatsContent = apps.get_model('cms', 'StatsContent')
    ContentType = apps.get_model('contenttypes', 'ContentType')

    HomepageStatisticsContent = apps.get_model('cms', 'HomepageStatisticsContent')

    DatabaseStatistic = apps.get_model('statistics', 'DatabaseStatistic')
    DatabaseStatistic.__bases__ = (models.Model, TranslatableModelMixin)
    DatabaseStatisticTranslation = apps.get_model('statistics', 'DatabaseStatisticTranslation')

    ManualStatistic = apps.get_model('statistics', 'ManualStatistic')
    ManualStatistic.__bases__ = (models.Model, TranslatableModelMixin)
    ManualStatisticTranslation = apps.get_model('statistics', 'ManualStatisticTranslation')

    for stats_content in StatsContent.objects.all():
        if stats_content.placeholder and stats_content.placeholder.parent_type.model == 'homepage':
            language = stats_content.language_code

            homepage_stats_content = HomepageStatisticsContent(
                language_code=language,
                parent_type=stats_content.parent_type,
                parent_id=stats_content.parent_id,
                sort_order=stats_content.sort_order,
                placeholder=stats_content.placeholder,
                contentitem_ptr=stats_content.contentitem_ptr,
                title=stats_content.title,
                sub_title=stats_content.sub_title,
                polymorphic_ctype_id=ContentType.objects.get_for_model(HomepageStatisticsContent).pk
            )
            homepage_stats_content.save()
            for stat in stats_content.stats.all():
                if stat.type:
                    database_statistic, _ = DatabaseStatistic.objects.get_or_create(
                        query=stat.type,
                        polymorphic_ctype_id=ContentType.objects.get_for_model(DatabaseStatistic).pk
                    )
                    DatabaseStatisticTranslation.objects.get_or_create(
                        language_code=language,
                        master=database_statistic,
                        defaults={
                            'name': stat.title
                        }
                    )
                else:
                    manual_statistic, _ = ManualStatistic.objects.get_or_create(
                        value=stat.value,
                        polymorphic_ctype_id=ContentType.objects.get_for_model(ManualStatistic).pk
                    )
                    ManualStatisticTranslation.objects.get_or_create(
                        language_code=language,
                        master=manual_statistic,
                        defaults={
                            'name': stat.title
                        }
                    )


class Migration(migrations.Migration):

    dependencies = [
        ('cms', '0059_homepagestatisticscontent'),
        ('statistics', '0009_auto_20200717_1201'),
    ]

    operations = [
        migrations.RunPython(migrate_hompepage_statistics)
    ]
