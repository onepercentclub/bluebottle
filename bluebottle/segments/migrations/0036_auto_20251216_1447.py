# Generated by Django 4.2.20 on 2025-12-16 13:47

from django.db import migrations, connection
from django.utils.translation import activate

from bluebottle.clients import properties
from bluebottle.clients.utils import LocalTenant


def migrate_segment_translations(apps, schema_editor):
    """
    Migrate old_name, old_tag_line, and old_story to translated fields
    for SegmentType and Segment models.
    """
    # Only run if we're in a tenant context (not public schema)
    if connection.tenant.schema_name == 'public':
        return

    Client = apps.get_model('clients', 'Client')
    SegmentType = apps.get_model('segments', 'SegmentType')
    SegmentTypeTranslation = apps.get_model('segments', 'SegmentTypeTranslation')
    Segment = apps.get_model('segments', 'Segment')
    SegmentTranslation = apps.get_model('segments', 'SegmentTranslation')

    try:
        tenant = Client.objects.get(schema_name=connection.tenant.schema_name)
    except Client.DoesNotExist:
        return

    with LocalTenant(tenant):
        language = properties.LANGUAGE_CODE

        for segment_type in SegmentType.objects.all():
            if not segment_type.old_name:
                continue

            SegmentTypeTranslation.objects.get_or_create(
                master_id=segment_type.pk,
                language_code=language,
                defaults={
                    'name': segment_type.old_name,
                }
            )

        for segment in Segment.objects.all():
            activate(language)

            SegmentTranslation.objects.get_or_create(
                master_id=segment.pk,
                language_code=language,
                defaults={
                    'name': segment.old_name or '',
                    'slogan': segment.old_tag_line or '',
                    'story': segment.old_story or '',
                }
            )


class Migration(migrations.Migration):
    dependencies = [
        ('segments', '0035_segmenttypetranslation_segmenttranslation'),
        ('clients', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(migrate_segment_translations, migrations.RunPython.noop),
    ]
